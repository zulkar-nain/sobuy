{% extends 'base.html' %}
{% from '_form_helpers.html' import render_field %}

{% block title %}Checkout - SoBuy{% endblock %}

{% block content %}
<div class="container mx-auto p-4 max-w-2xl">
    <h1 class="text-2xl font-bold mb-4">Checkout</h1>
    <form method="POST" class="bg-white p-6 rounded shadow-md">
        {{ form.hidden_tag() }}
        <h2 class="text-xl font-semibold mb-4">Delivery Details</h2>
        {{ render_field(form.name) }}
        {{ render_field(form.address) }}
        {{ render_field(form.phone) }}

        {% if not current_user.phone or not current_user.address %}
            <div class="mb-4">
                {{ render_field(form.save_to_profile) }}
            </div>
        {% endif %}

        <h2 class="text-xl font-semibold mb-4 mt-6">Payment</h2>
        <div class="mb-4">
            <label class="block text-gray-700">Select Payment Method</label>
            <select name="payment_method" id="payment_method" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm">
                <option value="cash_on_delivery" {% if form.payment_method.data == 'cash_on_delivery' %}selected{% endif %}>Cash on Delivery</option>
                <option value="bkash" {% if form.payment_method.data == 'bkash' %}selected{% endif %} {% if not active_bkash %}disabled title="bKash currently unavailable"{% endif %}>bKash</option>
            </select>
            {% if not active_bkash %}
                <p class="text-xs text-red-600 mt-1">bKash is temporarily disabled, Please use other payment methods!</p>
            {% endif %}
        </div>

        <div id="bkash-section" class="hidden mb-4">
            <div class="mb-2">
                <p class="text-sm text-gray-700">
                    {% if active_bkash %}
                        <strong class="text-lg">SEND MONEY to {{ active_bkash.number }}</strong>
                        <br>
                        <p class="text-sm text-gray-600 mt-1">(Do not call this number for any query)</p>
                        After sending, enter your sending bKash number and the transaction ID below.
                    {% else %}
                        <strong class="text-lg">bKash payments</strong>
                        <br>
                        No receiving bKash number is currently configured. Please contact support if you want to pay via bKash.
                    {% endif %}
                </p>
            </div>

            {{ render_field(form.bkash_number) }}
            {{ render_field(form.trx_id) }}
        </div>

        

        <!-- Order Summary -->
        <div class="mt-6 bg-gray-50 p-4 rounded">
            <h3 class="font-semibold mb-3">Order Summary</h3>
            
            {% if delivery %}
                <div class="flex justify-between text-sm mb-2">
                    <span>Subtotal:</span>
                    <span>৳{{ "%.2f"|format(total_amount - delivery.amount + (coupon.discount_amount if coupon else 0)) }}</span>
                </div>
                
                {% if coupon %}
                <div class="flex justify-between text-sm text-green-600 mb-2">
                    <span>Discount ({{ coupon.code }}):</span>
                    <span>-৳{{ "%.2f"|format(coupon.discount_amount) }}</span>
                </div>
                {% endif %}
                
                <div class="flex justify-between text-sm mb-2">
                    <span>Delivery ({{ delivery.label }}):</span>
                    <span>৳{{ "%.2f"|format(delivery.amount) }}</span>
                </div>
                
                <div class="border-t pt-2 mt-2 flex justify-between font-bold text-lg">
                    <span>Total:</span>
                    <span>৳{{ "%.2f"|format(total_amount) }}</span>
                </div>
            {% else %}
                <div class="text-sm text-red-600">No delivery option selected. Please go back to cart to choose one.</div>
            {% endif %}
        </div>

        <div class="mt-6 flex justify-end">
            {{ form.submit(class_='bg-primary text-white px-6 py-3 rounded hover:bg-accent') }}
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function(){
    const paymentSelect = document.getElementById('payment_method');
    const bkashSection = document.getElementById('bkash-section');
    if(!paymentSelect) return;
    function update(){
        if(paymentSelect.value === 'bkash'){
            bkashSection.classList.remove('hidden');
        } else {
            bkashSection.classList.add('hidden');
        }
    }
    paymentSelect.addEventListener('change', update);
    update();
});
</script>
{% endblock %}